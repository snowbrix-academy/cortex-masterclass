<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Module 08 — Automation: Tasks & Streams | Snowbrix Academy</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap');
  :root{--bg:#1A1A2E;--bg2:#16213E;--card:#0F3460;--cyan:#00D4FF;--orange:#FF6B35;--red:#E63946;--green:#06D6A0;--gray:#B0A8A0;--white:#E8E8E8;--dim:#6B7280;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--white);overflow:hidden;height:100vh;width:100vw;}
  .slide{display:none;width:100vw;height:100vh;padding:60px 80px;flex-direction:column;justify-content:center;position:relative;}
  .slide.active{display:flex;}
  .sn{position:absolute;bottom:30px;right:40px;font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--dim);}
  .mt{position:absolute;top:30px;left:40px;font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);letter-spacing:2px;text-transform:uppercase;}
  .bt{position:absolute;bottom:30px;left:40px;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--dim);}
  h1{font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:700;line-height:1.2;margin-bottom:24px;}
  h2{font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:700;margin-bottom:20px;line-height:1.3;}
  h3{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:600;margin-bottom:16px;color:var(--cyan);}
  p,li{font-size:22px;line-height:1.6;color:var(--gray);}
  .hl{color:var(--cyan);} .w{color:var(--orange);} .d{color:var(--red);} .g{color:var(--green);}
  ul{list-style:none;padding-left:0;} ul li{padding:8px 0;padding-left:30px;position:relative;}
  ul li::before{content:'>';position:absolute;left:0;color:var(--cyan);font-family:'JetBrains Mono',monospace;font-weight:700;}
  .cb{background:#0D1117;border:1px solid #30363D;border-radius:8px;padding:24px 28px;font-family:'Fira Code',monospace;font-size:17px;line-height:1.7;color:#C9D1D9;margin:20px 0;white-space:pre;overflow:auto;}
  .cb .kw{color:#FF7B72;} .cb .s{color:#A5D6FF;} .cb .c{color:#8B949E;} .cb .fn{color:#D2A8FF;} .cb .n{color:#79C0FF;}
  .g2{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:20px;}
  .g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:30px;margin-top:20px;}
  .cd{background:var(--bg2);border:1px solid #30363D;border-radius:12px;padding:28px;}
  .cd.hc{border-color:var(--cyan);} .cd.wc{border-color:var(--orange);}
  .bn{font-family:'JetBrains Mono',monospace;font-size:72px;font-weight:700;color:var(--cyan);line-height:1;}
  .sl{font-size:18px;color:var(--dim);margin-top:8px;}
  .ab{background:#0D1117;border:1px solid #30363D;border-radius:8px;padding:30px;font-family:'Fira Code',monospace;font-size:15px;line-height:1.6;color:var(--gray);white-space:pre;}
  .ts{text-align:center;justify-content:center;align-items:center;} .ts h1{font-size:52px;margin-bottom:16px;}
  .st{font-size:24px;color:var(--cyan);font-family:'JetBrains Mono',monospace;margin-bottom:40px;}
  table{width:100%;border-collapse:collapse;margin:16px 0;font-size:18px;}
  th{text-align:left;padding:12px 16px;background:var(--card);color:var(--cyan);font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600;border-bottom:2px solid var(--cyan);}
  td{padding:10px 16px;border-bottom:1px solid #30363D;color:var(--gray);}
  .pb{display:flex;gap:4px;margin:20px 0;} .pb .s{flex:1;height:6px;background:#30363D;border-radius:3px;} .pb .s.done{background:var(--cyan);} .pb .s.cur{background:var(--orange);}
  .tag{display:inline-block;padding:4px 12px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;margin:2px 4px;}
  .tag.task{background:#1a2a3a;color:#00D4FF;border:1px solid #00D4FF;}
  .tag.stream{background:#1a3a1a;color:#06D6A0;border:1px solid #06D6A0;}
  .tag.cron{background:#3a2a1a;color:#FF6B35;border:1px solid #FF6B35;}
</style>
</head>
<body>

<!-- SLIDE 1: Title -->
<div class="slide ts active">
  <div class="mt">Module 08</div>
  <div class="pb"><div class="s done"></div><div class="s done"></div><div class="s done"></div><div class="s done"></div><div class="s done"></div><div class="s done"></div><div class="s done"></div><div class="s cur"></div><div class="s"></div><div class="s"></div></div>
  <h1>Automation: Tasks &amp; Streams</h1>
  <div class="st">Scheduled Pipelines &bull; Change Data Capture &bull; Event-Driven Ingestion</div>
  <p style="font-size:20px;">Task trees for orchestration. Streams for CDC. Zero manual intervention.</p>
  <div class="sn">1 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 2: Why Automate -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Why Automate?</h2>
  <div class="g2">
    <div class="cd" style="border-color:var(--red);">
      <h3 style="color:var(--red);">Manual Execution</h3>
      <ul>
        <li>Someone runs CALL SP_INGEST at 6 AM</li>
        <li>Failures go unnoticed until users complain</li>
        <li>New sources require manual procedure calls</li>
        <li>Weekend and holiday gaps in data</li>
        <li>Zero scalability</li>
      </ul>
    </div>
    <div class="cd" style="border-color:var(--green);">
      <h3 style="color:var(--green);">Automated Pipeline</h3>
      <ul>
        <li>CRON schedule fires at 6 AM daily</li>
        <li>Retry tasks handle failures automatically</li>
        <li>Streams detect new config registrations</li>
        <li>Runs 365 days a year, no exceptions</li>
        <li>Scales to hundreds of sources</li>
      </ul>
    </div>
  </div>
  <p style="margin-top:24px;text-align:center;"><span class="w">Production war story:</span> A misconfigured manual pipeline missed 3 days of loads over a holiday weekend. Nobody noticed until Monday's dashboard was empty.</p>
  <div class="sn">2 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 3: CRON Syntax Reference -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>CRON Syntax Reference</h2>
  <div class="ab" style="font-size:16px;margin-bottom:16px;">
  ┌───────────── minute (0 - 59)
  │ ┌─────────── hour (0 - 23)
  │ │ ┌───────── day of month (1 - 31)
  │ │ │ ┌─────── month (1 - 12)
  │ │ │ │ ┌───── day of week (0 - 6) (Sun=0)
  │ │ │ │ │
  <span style="color:var(--cyan);">0 6 * * *</span>   America/New_York</div>
  <table>
    <tr><th>Expression</th><th>Schedule</th><th>Use Case</th></tr>
    <tr><td><span class="hl">0 6 * * *</span></td><td>6:00 AM daily</td><td>MDF_TASK_ROOT &mdash; daily batch</td></tr>
    <tr><td><span class="hl">0 * * * *</span></td><td>Every hour on the hour</td><td>MDF_TASK_HOURLY_INGEST</td></tr>
    <tr><td><span class="hl">*/5 * * * *</span></td><td>Every 5 minutes</td><td>Near-real-time ingestion</td></tr>
    <tr><td><span class="hl">30 8 * * 1-5</span></td><td>8:30 AM weekdays</td><td>Business-hours only loads</td></tr>
    <tr><td><span class="hl">0 0 1 * *</span></td><td>Midnight, 1st of month</td><td>Monthly aggregation tasks</td></tr>
  </table>
  <p style="margin-top:12px;"><span class="w">Always specify timezone.</span> Default is UTC. Use <span class="hl">America/New_York</span>, <span class="hl">Europe/London</span>, etc.</p>
  <div class="sn">3 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 4: Task Tree Architecture -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Task Tree Architecture</h2>
  <div class="ab" style="font-size:15px;line-height:1.8;">
                     <span style="color:var(--orange);">MDF_TASK_ROOT</span>
                 CRON '0 6 * * *' America/New_York
                    │
          ┌─────────┴─────────┐
          │                   │             <span style="color:var(--dim);">← parallel children</span>
  <span style="color:var(--cyan);">MDF_TASK_INGEST_CSV</span>   <span style="color:var(--cyan);">MDF_TASK_INGEST_JSON</span>
   AFTER ROOT               AFTER ROOT
   SP_INGEST_ALL_CSV()      SP_INGEST_ALL_JSON()
          │                   │
          └─────────┬─────────┘
                    │             <span style="color:var(--dim);">← waits for BOTH</span>
            <span style="color:var(--green);">MDF_TASK_RETRY</span>
     AFTER INGEST_CSV, INGEST_JSON
       SP_RETRY_FAILED_LOADS()</div>
  <p style="margin-top:16px;"><span class="w">Key rule:</span> Resume tasks <span class="hl">bottom-up</span>. Children first, root last. Reversing this silently breaks the chain.</p>
  <div class="sn">4 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 5: Task Creation Code -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Task Creation</h2>
  <div class="cb" style="font-size:14px;line-height:1.6;"><span class="c">-- 1. Root task (the only one with a SCHEDULE)</span>
<span class="kw">CREATE OR REPLACE TASK</span> MDF_CONTROL_DB.PROCEDURES.MDF_TASK_ROOT
  <span class="kw">WAREHOUSE</span> = MDF_INGESTION_WH
  <span class="kw">SCHEDULE</span>  = <span class="s">'USING CRON 0 6 * * * America/New_York'</span>
<span class="kw">AS</span> <span class="kw">CALL</span> <span class="fn">SP_LOG_TASK_START</span>(<span class="s">'MDF_DAILY_INGESTION'</span>);

<span class="c">-- 2. Parallel children (AFTER root, no schedule)</span>
<span class="kw">CREATE OR REPLACE TASK</span> ...MDF_TASK_INGEST_CSV
  <span class="kw">WAREHOUSE</span> = MDF_INGESTION_WH
  <span class="kw">AFTER</span> ...MDF_TASK_ROOT
<span class="kw">AS</span> <span class="kw">CALL</span> <span class="fn">SP_INGEST_ALL_CSV</span>();

<span class="c">-- 3. Retry (AFTER both children)</span>
<span class="kw">CREATE OR REPLACE TASK</span> ...MDF_TASK_RETRY
  <span class="kw">WAREHOUSE</span> = MDF_INGESTION_WH
  <span class="kw">AFTER</span> ...MDF_TASK_INGEST_CSV, ...MDF_TASK_INGEST_JSON
<span class="kw">AS</span> <span class="kw">CALL</span> <span class="fn">SP_RETRY_FAILED_LOADS</span>();

<span class="c">-- 4. Resume bottom-up</span>
<span class="kw">ALTER TASK</span> MDF_TASK_RETRY <span class="kw">RESUME</span>;
<span class="kw">ALTER TASK</span> MDF_TASK_INGEST_JSON <span class="kw">RESUME</span>;
<span class="kw">ALTER TASK</span> MDF_TASK_INGEST_CSV <span class="kw">RESUME</span>;
<span class="kw">ALTER TASK</span> MDF_TASK_ROOT <span class="kw">RESUME</span>;</div>
  <div class="sn">5 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 6: Streams — CDC Concept -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Streams &mdash; Change Data Capture</h2>
  <p style="margin-bottom:16px;">A stream tracks <span class="hl">row-level changes</span> on a table since the last consumption.</p>
  <div class="g2">
    <div class="cd hc">
      <h3>Standard Stream</h3>
      <p style="font-size:18px;">Tracks INSERTs, UPDATEs, DELETEs</p>
      <p style="font-size:16px;color:var(--dim);margin-top:8px;">Use for: INGESTION_CONFIG table</p>
      <div class="cb" style="font-size:13px;padding:16px;"><span class="kw">CREATE STREAM</span> MDF_CONFIG_STREAM
  <span class="kw">ON TABLE</span> INGESTION_CONFIG
  <span class="kw">SHOW_INITIAL_ROWS</span> = <span class="n">FALSE</span>;</div>
    </div>
    <div class="cd wc">
      <h3>Append-Only Stream</h3>
      <p style="font-size:18px;">Tracks INSERTs only &mdash; more efficient</p>
      <p style="font-size:16px;color:var(--dim);margin-top:8px;">Use for: INGESTION_AUDIT_LOG table</p>
      <div class="cb" style="font-size:13px;padding:16px;"><span class="kw">CREATE STREAM</span> MDF_AUDIT_STREAM
  <span class="kw">ON TABLE</span> INGESTION_AUDIT_LOG
  <span class="kw">APPEND_ONLY</span> = <span class="n">TRUE</span>;</div>
    </div>
  </div>
  <p style="margin-top:16px;">Metadata columns: <span class="hl">METADATA$ACTION</span> &bull; <span class="hl">METADATA$ISUPDATE</span> &bull; <span class="hl">METADATA$ROW_ID</span></p>
  <div class="sn">6 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 7: Stream-Triggered Tasks -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Stream-Triggered Tasks</h2>
  <p style="margin-bottom:16px;">Combine <span class="tag task">TASK</span> + <span class="tag stream">STREAM</span> + <span class="hl">WHEN</span> clause = event-driven execution.</p>
  <div class="cb" style="font-size:15px;line-height:1.7;"><span class="c">-- Only runs when someone registers a new data source</span>
<span class="kw">CREATE OR REPLACE TASK</span> MDF_TASK_PROCESS_CONFIG_CHANGES
  <span class="kw">WAREHOUSE</span> = MDF_ADMIN_WH
  <span class="kw">SCHEDULE</span>  = <span class="s">'USING CRON 0 * * * * America/New_York'</span>
  <span class="kw">WHEN</span>      = <span class="fn">SYSTEM$STREAM_HAS_DATA</span>(<span class="s">'MDF_CONTROL_DB.CONFIG.MDF_CONFIG_STREAM'</span>)
<span class="kw">AS</span>
  <span class="kw">CALL</span> <span class="fn">SP_PROCESS_NEW_REGISTRATIONS</span>();

<span class="c">-- Only runs when new audit entries exist</span>
<span class="kw">CREATE OR REPLACE TASK</span> MDF_TASK_HOURLY_INGEST
  <span class="kw">WAREHOUSE</span> = MDF_INGESTION_WH
  <span class="kw">SCHEDULE</span>  = <span class="s">'USING CRON 0 * * * * America/New_York'</span>
  <span class="kw">WHEN</span>      = <span class="fn">SYSTEM$STREAM_HAS_DATA</span>(<span class="s">'MDF_CONTROL_DB.AUDIT.MDF_AUDIT_STREAM'</span>)
<span class="kw">AS</span>
  <span class="kw">CALL</span> <span class="fn">SP_PROCESS_HOURLY_LOADS</span>();</div>
  <p style="margin-top:12px;"><span class="g">Benefit:</span> Zero compute cost when nothing changed. The WHEN clause checks the stream <span class="hl">before</span> starting the warehouse.</p>
  <div class="sn">7 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 8: Task Monitoring -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Task Monitoring Queries</h2>
  <div class="g2">
    <div class="cd hc">
      <h3>Task Execution History</h3>
      <div class="cb" style="font-size:13px;padding:16px;line-height:1.6;"><span class="kw">SELECT</span> NAME, STATE,
       SCHEDULED_TIME,
       COMPLETED_TIME,
       ERROR_CODE, ERROR_MESSAGE
<span class="kw">FROM TABLE</span>(<span class="fn">INFORMATION_SCHEMA
  .TASK_HISTORY</span>(
  SCHEDULED_TIME_RANGE_START
    =&gt; <span class="fn">DATEADD</span>(<span class="s">'hour'</span>,<span class="n">-24</span>,
       <span class="fn">CURRENT_TIMESTAMP</span>()),
  RESULT_LIMIT =&gt; <span class="n">50</span>
))
<span class="kw">ORDER BY</span> SCHEDULED_TIME <span class="kw">DESC</span>;</div>
    </div>
    <div class="cd wc">
      <h3>Stream Health Check</h3>
      <div class="cb" style="font-size:13px;padding:16px;line-height:1.6;"><span class="c">-- Check for stale streams</span>
<span class="kw">SELECT</span> STREAM_NAME,
       TABLE_NAME,
       STALE,
       STALE_AFTER,
       TYPE
<span class="kw">FROM</span> MDF_CONTROL_DB
  .INFORMATION_SCHEMA.STREAMS
<span class="kw">WHERE</span> STREAM_NAME
  <span class="kw">LIKE</span> <span class="s">'MDF_%'</span>;

<span class="c">-- Stale after 14 days
-- Alert if unconsumed &gt; 7 days</span></div>
    </div>
  </div>
  <p style="margin-top:16px;"><span class="w">Tip:</span> Query <span class="hl">TASK_HISTORY</span> daily. Build alerts for STATE = <span class="d">'FAILED'</span> and streams approaching STALE_AFTER.</p>
  <div class="sn">8 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 9: Recap -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Module 08 Complete</h2>
  <div class="g2">
    <div>
      <h3>What We Built</h3>
      <ul>
        <li>MDF_TASK_ROOT &mdash; CRON 6 AM daily</li>
        <li>MDF_TASK_INGEST_CSV + JSON &mdash; parallel</li>
        <li>MDF_TASK_RETRY &mdash; after both children</li>
        <li>MDF_CONFIG_STREAM &mdash; standard CDC</li>
        <li>MDF_AUDIT_STREAM &mdash; append-only CDC</li>
        <li>MDF_TASK_PROCESS_CONFIG_CHANGES</li>
        <li>MDF_TASK_HOURLY_INGEST</li>
      </ul>
    </div>
    <div>
      <h3>Key Takeaways</h3>
      <ul>
        <li>CRON schedules with explicit timezones</li>
        <li>Task trees: parent/child DAG dependencies</li>
        <li>Resume bottom-up, suspend top-down</li>
        <li>Standard streams for updates, append-only for logs</li>
        <li>SYSTEM$STREAM_HAS_DATA saves compute</li>
        <li>Monitor TASK_HISTORY and stream staleness</li>
      </ul>
    </div>
  </div>
  <div style="display:flex;gap:12px;justify-content:center;margin-top:30px;">
    <span class="tag cron">CRON</span>
    <span class="tag task">TASK TREES</span>
    <span class="tag stream">STREAMS</span>
    <span class="tag task">CDC</span>
    <span class="tag cron">WHEN CLAUSE</span>
  </div>
  <div class="sn">9 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<!-- SLIDE 10: Next Module -->
<div class="slide">
  <div class="mt">Module 08</div>
  <h2>Next: Module 09</h2>
  <div style="margin-top:40px;padding:28px;background:var(--bg2);border-left:4px solid var(--orange);border-radius:4px;">
    <p style="font-size:24px;color:var(--white);"><span class="w">Monitoring &amp; Dashboards</span></p>
    <p style="font-size:18px;color:var(--dim);margin-top:12px;">Dashboard views for pipeline health. What loaded. What failed. How long it took. Trend analysis and alerting.</p>
  </div>
  <div class="g3" style="margin-top:40px;">
    <div class="cd" style="text-align:center;">
      <div class="bn" style="font-size:48px;">6</div>
      <div class="sl">Tasks Created</div>
    </div>
    <div class="cd" style="text-align:center;">
      <div class="bn" style="font-size:48px;">2</div>
      <div class="sl">CDC Streams</div>
    </div>
    <div class="cd" style="text-align:center;">
      <div class="bn" style="font-size:48px;">0</div>
      <div class="sl">Manual Steps Left</div>
    </div>
  </div>
  <p style="margin-top:30px;text-align:center;">The pipeline is <span class="g">self-driving</span>. Now we need <span class="hl">observability</span>.</p>
  <div class="sn">10 / 10</div><div class="bt">snowbrix.academy</div>
</div>

<script>
let c=0;const ss=document.querySelectorAll('.slide'),n=ss.length;
function go(i){if(i>=0&&i<n){ss[c].classList.remove('active');c=i;ss[c].classList.add('active');}}
document.addEventListener('keydown',e=>{if(e.key==='ArrowRight'||e.key===' ')go(c+1);if(e.key==='ArrowLeft')go(c-1);});
document.addEventListener('click',e=>{if(e.clientX>window.innerWidth/2)go(c+1);else go(c-1);});
</script>
</body>
</html>
